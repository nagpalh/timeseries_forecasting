{% extends "base.html" %}

{% block title %}Forecast · {{ dataset.filename }} · Forecast Studio{% endblock %}

{% block content %}
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('upload') }}">Upload</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('visualize', dataset_id=dataset.id) }}">Explore</a></li>
            <li class="breadcrumb-item active" aria-current="page">Forecast</li>
        </ol>
    </nav>

    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">Forecast your future trajectory</h1>
            <p class="text-muted mb-0">{{ dataset.filename }} &middot; {{ forecast_steps }} period Holt-Winters projection</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="{{ url_for('visualize', dataset_id=dataset.id) }}"><i class="fa-solid fa-arrow-left me-2"></i>Back to explore</a>
            <a class="btn btn-primary" href="{{ url_for('upload') }}"><i class="fa-solid fa-cloud-arrow-up me-2"></i>Upload another dataset</a>
        </div>
    </div>

    <section class="mb-5">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="row g-4 align-items-center">
                    <div class="col-lg-4">
                        <span class="badge bg-success-subtle text-success mb-3">Step 3</span>
                        <h2 class="h4 fw-semibold">Interactive forecast</h2>
                        <p class="text-muted">Zoom, pan, and hover to inspect the projected path. The dashed line highlights the future horizon computed with Holt-Winters exponential smoothing.</p>
                        <div class="card bg-light border-0 mt-3">
                            <div class="card-body">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="rounded-circle bg-success text-white icon-circle"><i class="fa-solid fa-robot"></i></div>
                                    <div>
                                        <div class="fw-semibold">Model behaviour</div>
                                        <div class="text-muted small">Trend-free seasonal smoother with automatic frequency detection.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% if fit_diagnostics %}
                            <div class="mt-3">
                                <div class="alert {% if fit_diagnostics.converged %}alert-success{% else %}alert-warning{% endif %}" role="alert">
                                    <i class="fa-solid {% if fit_diagnostics.converged %}fa-circle-check{% else %}fa-triangle-exclamation{% endif %} me-2"></i>
                                    {% if fit_diagnostics.converged %}
                                        Optimisation converged successfully.
                                    {% else %}
                                        Optimiser did not report convergence.
                                    {% endif %}
                                </div>
                                {% if fit_diagnostics.general %}
                                    <div class="card border-0 shadow-sm mb-3">
                                        <div class="card-body p-3">
                                            <h3 class="h6 text-uppercase text-muted mb-2">Model metrics</h3>
                                            <ul class="list-unstyled small mb-0">
                                                {% for item in fit_diagnostics.general %}
                                                    <li class="d-flex justify-content-between"><span class="text-muted">{{ item.label }}</span><strong>{{ item.value }}</strong></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if fit_diagnostics.details %}
                                    <div class="card border-0 shadow-sm mb-3">
                                        <div class="card-body p-3">
                                            <h3 class="h6 text-uppercase text-muted mb-2">Optimiser details</h3>
                                            <ul class="list-unstyled small mb-0">
                                                {% for detail in fit_diagnostics.details %}
                                                    <li class="mb-1"><span class="text-muted">{{ detail.label }}:</span> <strong>{{ detail.value }}</strong></li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if fit_diagnostics.messages %}
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body p-3">
                                            <h3 class="h6 text-uppercase text-muted mb-2">Solver messages</h3>
                                            <ul class="list-unstyled small mb-0">
                                                {% for note in fit_diagnostics.messages %}
                                                    <li class="mb-1"><i class="fa-solid fa-circle-info text-primary me-2"></i>{{ note }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-lg-8">
                        <div id="forecast-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
                    <div>
                        <h2 class="h4 fw-semibold mb-1">Forecasted values</h2>
                        <p class="text-muted mb-0">Download the horizon, filter specific windows, or tap a cell to copy its value.</p>
                    </div>
                    <div class="badge bg-info-subtle text-info">
                        <i class="fa-solid fa-forward-step me-2"></i>{{ forecast_rows|length }} projected steps
                    </div>
                </div>

                <table id="forecast-table" class="table table-striped" style="width: 100%">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Forecast</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <section>
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h2 class="h5 fw-semibold mb-3">What to do with these insights?</h2>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="insight-card">
                            <div class="icon-circle bg-primary text-white"><i class="fa-solid fa-calendar-plus"></i></div>
                            <h3 class="h6 mt-3">Schedule production</h3>
                            <p class="text-muted small">Align staffing or manufacturing capacity with forecast peaks and troughs.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="insight-card">
                            <div class="icon-circle bg-warning text-dark"><i class="fa-solid fa-box-open"></i></div>
                            <h3 class="h6 mt-3">Optimise inventory</h3>
                            <p class="text-muted small">Pre-empt stockouts or overstocks by mapping forecasts to reorder points.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="insight-card">
                            <div class="icon-circle bg-success text-white"><i class="fa-solid fa-chart-simple"></i></div>
                            <h3 class="h6 mt-3">Share dashboards</h3>
                            <p class="text-muted small">Export tables to Excel and embed the Plotly figure in stakeholder updates.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const plotContainer = document.getElementById('forecast-chart');
            if (plotContainer) {
                const plotPayload = {{ forecast_plot | tojson }};
                Plotly.newPlot(plotContainer, plotPayload.data, plotPayload.layout, {
                    responsive: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['select2d', 'lasso2d']
                });
            }

            const forecastData = {{ forecast_rows | tojson }};
            window.renderDataTable('forecast-table', [
                { title: 'Timestamp', data: 'timestamp' },
                { title: 'Forecast', data: 'forecast', render: window.renderNumeric(3) }
            ], forecastData, {
                order: [],
                scrollY: '55vh',
            });
        });
    </script>
{% endblock %}
